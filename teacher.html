<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ë–∞–≥—à–∏–π–Ω –±–∞–π—Ä—à–∏–ª</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #form { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1.5em; gap: 12px; }
    input, button {
      padding: 12px;
      font-size: 1rem;
      width: 90%;
      max-width: 300px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    #map {
      width: 100vw;
      height: 100vh;
      display: none;
    }
    #follow-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 5;
      padding: 10px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="form">
    <input type="number" id="grade" placeholder="–ê–Ω–≥–∏ (–∂: 2)">
    <button onclick="loadClass()">–ê–Ω–≥–∏–π–Ω –±–∞–π—Ä—à–∏–ª —Ö–∞—Ä–∞—Ö</button>
  </div>

  <div id="map"></div>
  <button id="follow-btn" onclick="enableFollow()" style="display:none;">üîÅ GPS —Ç”©–≤–ª”©—Ä”©—Ö</button>

  <script>
    let map;
    let teacherMarker = null;
    let studentMarkers = [];
    let autoFollow = true;

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 47.909, lng: 106.907 },
        zoom: 20,
        mapTypeId: 'satellite'
      });

      map.addListener("dragstart", () => autoFollow = false);
    }

    function enableFollow() {
      autoFollow = true;
    }

    function loadClass() {
      const grade = document.getElementById('grade').value.trim();
      if (!grade) {
        alert("–ê–Ω–≥–∏–∞ –æ—Ä—É—É–ª–Ω–∞ —É—É.");
        return;
      }

      fetch(`data/${grade}.json`)
        .then(res => res.json())
        .then(students => {
          if (!Array.isArray(students)) {
            alert("–§–æ—Ä–º–∞—Ç –∞–ª–¥–∞–∞—Ç–∞–π.");
            return;
          }

          document.getElementById("form").style.display = "none";
          document.getElementById("map").style.display = "block";
          document.getElementById("follow-btn").style.display = "block";

          studentMarkers.forEach(m => m.setMap(null));
          studentMarkers = [];

          let latSum = 0, lngSum = 0, count = 0;
          students.forEach(s => {
            if (s.Latitude && s.Longitude) {
              const pos = { lat: parseFloat(s.Latitude), lng: parseFloat(s.Longitude) };
              const marker = new google.maps.Marker({
                position: pos,
                map,
                title: `–î—É–≥–∞–∞—Ä: ${s.–î—É–≥–∞–∞—Ä || ''}`,
              });
              const info = new google.maps.InfoWindow({
                content: `<b>${s.–ù—ç—Ä || '–ù—ç—Ä–≥“Ø–π'}</b><br>–î—É–≥–∞–∞—Ä: ${s.–î—É–≥–∞–∞—Ä || '-'}<br><i>–ë–∞–≥—à: ${s.–ë–∞–≥—à || '-'}</i>`
              });
              marker.addListener('click', () => info.open(map, marker));
              studentMarkers.push(marker);
              latSum += pos.lat;
              lngSum += pos.lng;
              count++;
            }
          });

          if (count > 0) {
            map.setCenter({ lat: latSum / count, lng: lngSum / count });
          }

          trackTeacher();
        })
        .catch(err => {
          console.error(err);
          alert("–§–∞–π–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.");
        });
    }

    function trackTeacher() {
      if (!navigator.geolocation) {
        alert("GPS –¥—ç–º–∂–∏—Ö–≥“Ø–π –±–∞–π–Ω–∞.");
        return;
      }

      navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = pos.coords.accuracy;

        if (teacherMarker) teacherMarker.setMap(null);

        teacherMarker = new google.maps.Circle({
          strokeColor: "#f03",
          strokeOpacity: 1,
          strokeWeight: 1,
          fillColor: "#f03",
          fillOpacity: 0.8,
          map,
          center: { lat, lng },
          radius: 0.5  // ‚úÖ 0.5 –º–µ—Ç—Ä
        });

        if (autoFollow) {
          map.setCenter({ lat, lng });
          map.setZoom(23); // üîç –•–∞–º–≥–∏–π–Ω –æ–π—Ä —Ç“Ø–≤—à–∏–Ω
        }

      }, err => {
        console.error("GPS –∞–ª–¥–∞–∞:", err);
      }, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 2000
      });
    }
  </script>

  <!-- ‚úÖ Google Maps API –∞—à–∏–≥–ª–∞–Ω–∞ -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCKsU91WwiYtAa3PRIU5-0UuaVBZjoInI&callback=initMap">
  </script>
</body>
</html>
