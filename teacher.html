<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°—É—Ä–∞–≥—á–∏–π–Ω –±–∞–π—Ä—à–∏–ª</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #form {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1em;
      gap: 10px;
    }

    input, button {
      padding: 10px;
      font-size: 16px;
      width: 90%;
      max-width: 300px;
      box-sizing: border-box;
    }

    #map {
      height: 100vh;
      width: 100%;
      display: none;
    }

    #follow-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 999;
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="form">
    <input type="number" id="grade" placeholder="–ê–Ω–≥–∏ (–∂: 1)">
    <input type="number" id="number" placeholder="–î—É–≥–∞–∞—Ä (–∂: 2)">
    <button onclick="search()">–•–∞–π—Ö</button>
  </div>

  <div id="map"></div>
  <button id="follow-btn" onclick="autoFollow = true" style="display:none;">üîÅ GPS —Ç”©–≤–ª”©—Ä”©—Ö</button>

  <script>
    let map, studentMarker = null, yourMarker = null, autoFollow = true, studentTarget = null, notified = false;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 47.909, lng: 106.907 },
        zoom: 20,
        mapTypeControl: false
      });

      map.addListener("dragstart", () => autoFollow = false);
    }

    function search() {
      const grade = document.getElementById("grade").value.trim();
      const number = parseInt(document.getElementById("number").value.trim());

      if (!grade || isNaN(number)) {
        alert("–ê–Ω–≥–∏ –±–æ–ª–æ–Ω –¥—É–≥–∞–∞—Ä–∞–∞ –æ—Ä—É—É–ª–Ω–∞ —É—É.");
        return;
      }

      fetch(`data/${grade}.json`)
        .then(res => res.json())
        .then(data => {
          const student = data.find(s => Number(s.–î—É–≥–∞–∞—Ä) === number);
          if (!student) {
            alert("–°—É—Ä–∞–≥—á –æ–ª–¥—Å–æ–Ω–≥“Ø–π.");
            return;
          }

          document.getElementById("form").style.display = "none";
          document.getElementById("map").style.display = "block";
          document.getElementById("follow-btn").style.display = "block";

          const studentPos = { lat: parseFloat(student.Latitude), lng: parseFloat(student.Longitude) };

          if (studentMarker) studentMarker.setMap(null);
          studentMarker = new google.maps.Marker({
            position: studentPos,
            map: map,
            title: `–ù—ç—Ä: ${student.–ù—ç—Ä || '–ù—ç—Ä–≥“Ø–π'}\n–ë–∞–≥—à: ${student.–ë–∞–≥—à || '-'}\n–î—É–≥–∞–∞—Ä: ${student.–î—É–≥–∞–∞—Ä}`
          });

          map.setCenter(studentPos);
          studentTarget = student;
          notified = false;

          trackYourPosition();
        })
        .catch(err => {
          console.error(err);
          alert("–§–∞–π–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.");
        });
    }

    function getDistanceMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function trackYourPosition() {
      if (!navigator.geolocation) {
        alert("–¢–∞–Ω—ã —Ç”©—Ö”©”©—Ä”©–º–∂ GPS –¥—ç–º–∂–∏—Ö–≥“Ø–π –±–∞–π–Ω–∞.");
        return;
      }

      navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = pos.coords.accuracy;

        if (acc > 10) return;

        const yourPos = { lat, lng };

        if (yourMarker) yourMarker.setMap(null);
        yourMarker = new google.maps.Circle({
          center: yourPos,
          radius: 3,
          map: map,
          fillColor: "#00f",
          fillOpacity: 0.6,
          strokeColor: "#00f",
          strokeOpacity: 0.8,
          strokeWeight: 1
        });

        if (autoFollow) {
          map.setCenter(yourPos);
        }

        if (!notified && studentTarget) {
          const dist = getDistanceMeters(lat, lng, parseFloat(studentTarget.Latitude), parseFloat(studentTarget.Longitude));
          if (dist <= 0.5) {
            notified = true;
            alert("‚úÖ –¢–∞ –∑”©–≤ –±–∞–π—Ä–∞–Ω –¥—ç—ç—Ä –∏—Ä–ª—ç—ç!");
            if (navigator.vibrate) navigator.vibrate(300);
          }
        }

      }, err => {
        console.error("GPS –∞–ª–¥–∞–∞:", err);
      }, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 1500
      });
    }
  </script>

  <!-- üîë GOOGLE MAPS API KEY —ç–Ω–¥ –æ—Ä—Å–æ–Ω -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCKsU91WwiYtAa3PRIU5-0UuaVBZjoInI&callback=initMap"></script>
</body>
</html>
